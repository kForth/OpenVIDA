{% extends "layout.html" %} {% block content %}
<div class="container">
    <div class="row g-5 py-2">
        <div class="col-md-5 col-lg-4 order-md-last">
            <img data-bind="attr: {src: imagePath}" />
        </div>
        <div class="col-md-7 col-lg-8">
            <h4 class="mb-3">Vehicle Profile</h4>
            <form onsubmit="return false;">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="partnerGroup" class="form-label"
                            >Partner Group</label
                        >
                        <select
                            class="form-control"
                            id="partnerGroup"
                            data-bind="value: partnerGroup, options: partnerGroupOptions, optionsValue: 'id', optionsText: 'text'"
                        ></select>
                    </div>
                    <hr class="mb-3" />
                    <div class="col-12 mb-3">
                        <label for="vin" class="form-label">VIN</label>
                        <div class="input-group">
                            <input
                                type="text"
                                class="form-control"
                                id="vin"
                                data-bind="value: vinNumber"
                            />
                            <button
                                class="btn btn-primary"
                                id="submitVin"
                                data-bind="click: loadProfileFromVin"
                            >
                                Submit
                            </button>
                        </div>
                    </div>
                    <hr class="mb-3" />
                    <div class="col-sm-6">
                        <label for="vehicleModel" class="form-label"
                            >Model</label
                        >
                        <input
                            id="vehicleModel"
                            type="text"
                            class="form-control"
                            data-bind="jqAuto: {value: vehicleModel, source: vehicleModelOptions, valueProp: 'id', labelProp: 'text', options: {minLength: 0}}"
                        />
                    </div>
                    <div class="col-sm-6">
                        <label for="modelYear" class="form-label"
                            >Model Year</label
                        >
                        <input
                            class="form-control"
                            id="modelYear"
                            data-bind="jqAuto: {value: modelYear, source: modelYearOptions, valueProp: 'id', labelProp: 'text', options: {minLength: 0}}"
                        />
                    </div>
                    <div class="col-sm-6">
                        <label for="engine" class="form-label">Engine</label>
                        <input
                            class="form-control"
                            id="engine"
                            data-bind="jqAuto: {value: engine, source: engineOptions, valueProp: 'id', labelProp: 'text', options: {minLength: 0}}"
                        />
                    </div>
                    <div class="col-sm-6">
                        <label for="transmission" class="form-label"
                            >Transmission</label
                        >
                        <input
                            class="form-control"
                            id="transmission"
                            data-bind="jqAuto: {value: transmission, source: transmissionOptions, valueProp: 'id', labelProp: 'text', options: {minLength: 0}}"
                        />
                    </div>
                    <div class="col-sm-4">
                        <label for="steering" class="form-label"
                            >Steering</label
                        >
                        <select
                            class="form-control"
                            id="steering"
                            data-bind="value: steering, options: steeringOptions, optionsValue: 'id', optionsText: 'text'"
                        ></select>
                    </div>
                    <div class="col-sm-4">
                        <label for="bodyStyle" class="form-label"
                            >Body Style</label
                        >
                        <select
                            class="form-control"
                            id="bodyStyle"
                            data-bind="value: bodyStyle, options: bodyStyleOptions, optionsValue: 'id', optionsText: 'text'"
                        ></select>
                    </div>
                    <div class="col-sm-4">
                        <label for="specialVehicle" class="form-label"
                            >Special Vehicle</label
                        >
                        <select
                            class="form-control"
                            id="specialVehicle"
                            data-bind="value: specialVehicle, options: specialVehicleOptions, optionsValue: 'id', optionsText: 'text'"
                        ></select>
                    </div>
                    <div class="col-12 col-sm-4 offset-sm-8">
                        <button
                            class="btn btn-primary w-100"
                            data-bind="click: submitProfile"
                        >
                            Submit
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %} {% block js %}
<script type="text/javascript">
    class ProfileViewModel {
        constructor() {
            var self = this;

            self.selectedProfile = ko.observable(
                sessionStorage.getItem("selectedProfile")
            );
            self.selectedProfile.subscribe((v) => {
                sessionStorage.setItem("selectedProfile", v);
            });

            self.imagePath = ko.observable("");
            self.vinNumber = ko.observable("");
            self.partnerGroup = ko.observable(null);
            self.vehicleModel = ko.observable(null);
            self.modelYear = ko.observable(null);
            self.engine = ko.observable(null);
            self.transmission = ko.observable(null);
            self.steering = ko.observable(null);
            self.bodyStyle = ko.observable(null);
            self.specialVehicle = ko.observable(null);

            self.partnerGroupOptions = ko.observableArray([]);
            self.vehicleModelOptions = ko.observableArray([
                { id: null, text: "" },
            ]);
            self.modelYearOptions = ko.observableArray([
                { id: null, text: "" },
            ]);
            self.engineOptions = ko.observableArray([{ id: null, text: "" }]);
            self.transmissionOptions = ko.observableArray([
                { id: null, text: "" },
            ]);
            self.steeringOptions = ko.observableArray([{ id: null, text: "" }]);
            self.bodyStyleOptions = ko.observableArray([
                { id: null, text: "" },
            ]);
            self.specialVehicleOptions = ko.observableArray([
                { id: null, text: "" },
            ]);

            self.pushAll = function (arr1, arr2) {
                for (let e of arr2) {
                    arr1.push(e);
                }
            };
            $.get("/Vida/partnerGroups", (resp) =>
                self.pushAll(self.partnerGroupOptions, resp)
            );
            $.get("/Vida/vehicleModels", (resp) =>
                self.pushAll(self.vehicleModelOptions, resp)
            );
            $.get("/Vida/modelYears", (resp) =>
                self.pushAll(self.modelYearOptions, resp)
            );
            $.get("/Vida/engines", (resp) =>
                self.pushAll(self.engineOptions, resp)
            );
            $.get("/Vida/transmissions", (resp) =>
                self.pushAll(self.transmissionOptions, resp)
            );
            $.get("/Vida/steerings", (resp) =>
                self.pushAll(self.steeringOptions, resp)
            );
            $.get("/Vida/bodyStyles", (resp) =>
                self.pushAll(self.bodyStyleOptions, resp)
            );
            $.get("/Vida/specialVehicles", (resp) =>
                self.pushAll(self.specialVehicleOptions, resp)
            );

            self.vinNumber.subscribe(function () {
                var match = self
                    .vinNumber()
                    .match(
                        /^[\d\w][\d\w][\d\w][\d\w][\d\w][\d\w][\d\w][\d\w][\d\w][\d\w][\d\w](\d{6})$/
                    );
                $("#vin").toggleClass(
                    "is-invalid",
                    !match && self.vinNumber().length > 0
                );
            });

            self.loadProfileFromVin = function () {
                $.ajax({
                    url: "/Vida/decode_vin/",
                    contentType:
                        "application/x-www-form-urlencoded; charset=UTF-8",
                    data: {
                        vinNumber: self.vinNumber(),
                        partnerGroup: self.partnerGroup(),
                    },
                    success: (resp) => {
                        self.imagePath(`/Vida/DataImages/${resp.image}`);

                        self.modelYear(
                            resp.year ||
                                self
                                    .modelYearOptions()
                                    .find((e) => e.id == resp.year).id
                        );
                        self.vehicleModel(
                            resp.model ||
                                self
                                    .vehicleModelOptions()
                                    .find((e) => e.id == resp.model).id
                        );
                        self.transmission(
                            resp.transmission ||
                                self
                                    .transmissionOptions()
                                    .find((e) => e.id == resp.transmission).id
                        );
                        self.engine(
                            resp.engine ||
                                self
                                    .engineOptions()
                                    .find((e) => e.id == resp.engine).id
                        );
                        self.bodyStyle(
                            resp.body ||
                                self
                                    .bodyStyleOptions()
                                    .find((e) => e.id == resp.body).id
                        );
                        self.submitProfile();
                    },
                });
            };

            self.submitProfile = function () {
                let data = {
                    fkPartnerGroup: self.partnerGroup(),
                    fkVehicleModel: self.vehicleModel(),
                    fkModelYear: self.modelYear(),
                    fkEngine: self.engine(),
                    fkTransmission: self.transmission(),
                    fkSteering: self.steering(),
                    fkBodyStyle: self.bodyStyle(),
                    fkSpecialVehicle: self.specialVehicle(),
                };
                $.ajax({
                    url: "/Vida/profiles",
                    data: data,
                    success: (resp) => self.selectedProfile(resp.Id),
                });
            };
        }
    }

    ko.applyBindings(new ProfileViewModel());

    // Show autocomplete options on focus
    $(".ui-autocomplete-input").on("focus", (e1) => {
        if (!$(e1.currentTarget).val())
            $(e1.currentTarget).autocomplete("search", "");
    });
</script>
{% endblock %}
